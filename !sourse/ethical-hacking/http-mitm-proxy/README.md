# [How to Make an HTTP Proxy in Python](https://www.thepythoncode.com/article/writing-http-proxy-in-python-with-mitmproxy)
To run this:
- Install [mitmproxy](https://mitmproxy.org/).
- Run the following command:
    ```
    $ mitmproxy --ignore '^(?!duckduckgo\.com)' -s proxy.py
    ```
- Test your proxy via configuring your browser or tools such as iptables (check [the tutorial](https://www.thepythoncode.com/article/writing-http-proxy-in-python-with-mitmproxy) for more info), or you can test it out with `curl`:
    ```
    $ curl -x http://127.0.0.1:8080/ -k https://duckduckgo.com/
    ```
##
# [[] / []]()
Сетевой прокси-сервер — это промежуточная сетевая служба, к которой пользователи могут подключаться и которая полагает свой трафик на другие серверы. Прокси-серверы могут быть разных типов. Чтобы перечислить некоторые из них, есть:

Обратные прокси: прокси, которые скрывают адреса серверов, к которым вы пытаетесь подключиться. Помимо очевидного варианта использования безопасности, они часто используются для выполнения задач балансировки нагрузки, когда обратный прокси-сервер решает, на какой сервер он должен переслать запрос и кэширование. Популярными обратными прокси являются HAProxy, Nginx и Squid.
Прозрачные прокси: это прокси, которые передают ваши данные на сервер, не предлагая никакой анонимности. Они по-прежнему изменяют исходный IP-адрес пакетов на IP-адрес прокси. Они могут помочь реализовать антивирусную или интернет-фильтрацию в корпоративных сетях, а также могут использоваться для обхода простых запретов на основе исходного IP-адреса.
Анонимные прокси: это прокси, которые скрывают вашу личность от целевого сервера; они в основном используются для анонимности.
По протоколу прокси также могут использовать различные протоколы для выполнения своих функций. Наиболее популярными являются:

HTTP прокси: протокол HTTP поддерживает прокси-серверы; Метод CONNECT запрашивает у прокси-сервера туннель с удаленным сервером.
Socks Proxies: Протокол Socks, который использует Kerberos для аутентификации, также широко используется для прокси.
Связанные с: Как использовать прокси-серверы для поворота IP-адресов в Python.

Mitmproxy - это современный HTTP/HTTPS прокси с открытым исходным кодом; он предлагает широкий спектр функций, утилиту командной строки, веб-интерфейс и PYTHON API для написания сценариев. В этом уроке мы будем использовать его для реализации прокси-сервера, который добавляет код HTML и Javascript на определенные веб-сайты, которые мы посещаем, и мы также заставим его работать с HTTP и HTTPS.

Во-первых, нам нужно установить mitmproxy, это можно быстро сделать с помощью следующей команды на системах на базе Debian:

$ sudo apt install mitmproxy
Хотя настоятельно рекомендуется следовать вместе с машиной Linux, вы также можете установить mitmproxy на Windows на официальном веб-сайте mitmproxy.

Для этого учебника мы напишем простой прокси-сервер, который добавляет наложение на некоторые посещенные страницы, не позволяя пользователю щелкнуть что-либо на странице, добавив HTML-код наложения к HTTP-ответу.

Ниже приведен код прокси:

OVERLAY_HTML = b"<img style='z-index:10000;width:100%;height:100%;top:0;left:0;position:fixed;opacity:0.5' src='https://cdn.winknews.com/wp-content/uploads/2019/01/Police-lights.-Photo-via-CBS-News..jpg' />"
OVERLAY_JS = b"<script>alert('You can\'t click anything on this page');</script>"

def remove_header(response, header_name):
    if header_name in response.headers:
        del response.headers[header_name]


def response(flow):
    # remove security headers in case they're present
    remove_header(flow.response, "Content-Security-Policy")
    remove_header(flow.response, "Strict-Transport-Security")
    # if content-type type isn't available, ignore
    if "content-type" not in flow.response.headers:
        return
    # if it's HTML & response code is 200 OK, then inject the overlay snippet (HTML & JS)
    if "text/html" in flow.response.headers["content-type"] and flow.response.status_code == 200:
        flow.response.content += OVERLAY_HTML
        flow.response.content += OVERLAY_JS
Связанные с: Создание 24 этических хакерских скриптов и инструментов с помощью Python EBook

Сценарий проверяет, содержит ли ответ HTML-данные и имеет ли код ответа значение 200 OK, если это так, он добавляет код HTML и Javascript на страницу.

Политика безопасности содержимого (CSP) — это заголовок, который предписывает браузеру загружать сценарии только из определенных источников; мы удаляем его, чтобы иметь возможность вставлять встроенные скрипты или загружать скрипты из разных источников.

Заголовок HTTP Strict Transport Security (HSTS) указывает браузеру подключаться к этому веб-сайту только через HTTPS в будущем. Если браузер получает этот заголовок, никто посередине не будет возможен, когда он будет получать доступ к этому веб-сайту до истечения срока действия правила HSTS.

Сохраняем приведенный выше скрипт под именем proxy.py и выполняем его с помощью команды mitmproxy:

$ mitmproxy --ignore '^(?!duckduckgo\.com)' -s proxy.py
Флаг --ignore указывает mitmproxy не передавать прокси-серверы никаким доменам, кроме duckduckgo.com (в противном случае при извлечении любого междоменного ресурса сертификат будет недействительным, и это может нарушить работу веб-страницы), регулярное выражение является отрицательным взглядом.

Теперь прокси прослушивает адрес localhost:8080, мы должны сказать нашему браузеру, чтобы он использовал его или перенаправлял трафик на него прозрачно с помощью инструмента iptables в Linux.

В браузере Firefox мы можем сделать это из настроек сети:

Изменение прокси в настройках сети в FirefoxНо если мы хотим выполнять работу прокси для каждого приложения в нашей системе, нам придется использовать iptables (в случае системы Linux), чтобы перенаправить весь трафик TCP на наш прокси:

$ iptables -t nat -A OUTPUT -p tcp --match multiport --dports 80,443 -j REDIRECT --to-ports 8080
Теперь зайдите в браузер и посетите duckduckgo.com. Конечно, если веб-сайт использует HTTPS (а это так), мы получим предупреждение о сертификате, потому что mitmproxy генерирует свой собственный сертификат, чтобы иметь возможность изменять HTML-код:

Потенциальный риск для безопасностиНо если сайт еще не предварительно загружен в списке предзагрузки HSTS (если это так, браузер не позволит обойти предупреждение), мы можем продолжить и посетить страницу:

Внедрено наложение HTML-кодаКак видите, мы не сможем ничего делать на сайте, так как внедренный HTML-оверлей мешает нам. Вы также можете проверить, действительно ли работает прокси-сервер, выполнив следующую команду:curl

$ curl -x http://127.0.0.1:8080/ -k https://duckduckgo.com/
Получите: Создайте 24 этических хакерских скрипта и инструмента с помощью Python EBook

Если он работает правильно, вы увидите внедренный код в конце, как показано на следующем рисунке:

Внедренный HTML/JS кодЗаключение
Обратите внимание, что мы можем использовать скрипт в различных режимах прокси, поддерживаемых mitmproxy, включая обычный, прозрачный, socks5, обратный и восходящий прокси.

Mitmproxy не ограничивается тем, чтобы быть HTTP-прокси. Мы также можем передавать данные WebSocket или даже необработанные данные TCP очень похожим способом.