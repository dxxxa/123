# [Detecting ARP Spoof attacks](https://www.thepythoncode.com/article/detecting-arp-spoof-attacks-using-scapy)
to run this:
- `pip3 install -r requirements.txt`
- 
    ```
    python3 detect_arpspoof.py wlan0
    ```
##
# [[] / []]()
В предыдущем уроке мы создали сценарий ARP-подделки с помощью Scapy, который, как только он будет установлен правильно, любой трафик, предназначенный для целевого хоста, будет отправлен на хост злоумышленника. Теперь вы, возможно, задаетесь вопросом, как мы можем обнаружить такие атаки? ну, это то, что мы собираемся сделать в этом уроке.

Основная идея сценария, который мы собираемся создать, заключается в том, чтобы продолжать перехватывать пакеты (пассивный мониторинг или сканирование) в сети. После получения ARP-пакета мы анализируем два компонента:

Исходный MAC-адрес (который можно подделать).
Реальный MAC-адрес отправителя (мы можем легко получить его, инициировав ARP-запрос исходного IP-адреса).
А затем мы сравним их. Если они не одинаковы, то мы определенно находимся под атакой подделки ARP!

Получите: Создайте 24 этических хакерских скрипта и инструмента с помощью Python Book

Написание сценария
Во-первых, давайте импортируем то, что нам понадобится (вам нужно сначала установить Scapy, перейдите к этому руководству или официальной документации Scapy для установки):

from scapy.all import Ether, ARP, srp, sniff, conf
Затем нам нужна функция, которая, учитывая IP-адрес, делает ARP-запрос и извлекает реальный MAC-адрес, этот IP-адрес:

def get_mac(ip):
    """
    Returns the MAC address of `ip`, if it is unable to find it
    for some reason, throws `IndexError`
    """
    p = Ether(dst='ff:ff:ff:ff:ff:ff')/ARP(pdst=ip)
    result = srp(p, timeout=3, verbose=False)[0]
    return result[0][1].hwsrc
Связанные с: Создание 24 этических хакерских скриптов и инструментов с помощью Python Book

После этого функция sniff(), которую мы собираемся использовать, принимает обратный вызов (или функцию) для применения к каждому сниффлированному пакету, давайте определим его:

def process(packet):
    # if the packet is an ARP packet
    if packet.haslayer(ARP):
        # if it is an ARP response (ARP reply)
        if packet[ARP].op == 2:
            try:
                # get the real MAC address of the sender
                real_mac = get_mac(packet[ARP].psrc)
                # get the MAC address from the packet sent to us
                response_mac = packet[ARP].hwsrc
                # if they're different, definitely there is an attack
                if real_mac != response_mac:
                    print(f"[!] You are under attack, REAL-MAC: {real_mac.upper()}, FAKE-MAC: {response_mac.upper()}")
            except IndexError:
                # unable to find the real mac
                # may be a fake IP or firewall is blocking packets
                pass
Примечание: Scapy кодирует тип пакета ARP в поле под названием «op», которое означает операцию, по умолчанию «op» равно 1 или «who-has», что является запросом ARP, а 2 или «is-at» является ответом ARP.

Как видите, приведенная выше функция проверяет наличие ARP-пакетов. Точнее, ARP отвечает, а затем сравнивает между реальным MAC-адресом и ответным MAC-адресом (который отправляется в самом пакете).

Все, что нам нужно сделать сейчас, это вызвать функцию sniff() с обратным вызовом, написанным выше:

sniff(store=False, prn=process)
Примечание: store=False сообщает функции sniff() отбрасывать снифрованные пакеты вместо того, чтобы хранить их в памяти, это полезно, когда скрипт работает очень долго.

При попытке запустить скрипт ничего не произойдет, очевидно, но когда злоумышленник попытается подделать ваш кэш ARP, как показано на рисунке ниже:

Выполняется скрипт ARP Spoof

Детектор подделки ARP (который, очевидно, работал на другой машине) автоматически ответит:

Детектор обнаруживает подделку ARPХорошо, вот и все!

Чтобы предотвратить такие атаки типа «злоумышленник посередине», вам необходимо использовать Dynamic ARP Inspection, которая является функцией безопасности, которая автоматически отклоняет вредоносные пакеты ARP, которые мы только что обнаружили.

Вот некоторые дополнительные чтения:

Обнаружение и предотвращение атак ARP Poison.
Создание ARP Spoofer на Python с помощью Scapy.
XArp – Расширенное обнаружение Спуфинга ARP.